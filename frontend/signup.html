<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <title>TheMove - Sign Up</title>
    <!-- ‚úÖ Tailwind + Poppins -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/styles.css" />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ["Poppins", "sans-serif"] },
            colors: {
              primary: "#4F46E5",
              accent: "#6366F1",
              background: "#FAFAFA",
              dark: "#1E1B4B",
            },
          },
        },
      };
    </script>
  </head>

  <body class="bg-background font-sans text-gray-800 flex flex-col min-h-screen">
    <!-- ‚úÖ Navbar -->
    <header class="navbar">
      <div class="navbar-container">
        <a href="/" class="navbar-logo">TheMove</a>
        <button class="navbar-mobile-toggle" id="mobileMenuToggle" aria-label="Toggle menu">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
        <nav class="navbar-nav" id="navbarNav">
          <a href="/login" class="btn btn-secondary">Login</a>
          <a href="/signup" class="btn btn-primary">Join</a>
        </nav>
      </div>
    </header>
    <script>
      document.getElementById('mobileMenuToggle')?.addEventListener('click', () => {
        document.getElementById('navbarNav')?.classList.toggle('open');
      });
    </script>

    <!-- ‚úÖ Main Content -->
    <main class="flex-grow flex items-center justify-center py-12 px-4">
      <div class="container container-sm">
        <div class="card max-w-md mx-auto fade-in">
          <h1 class="heading-2 text-center mb-2">Sign Up for TheMove</h1>
          <p class="text-muted text-center mb-8">Join other students discovering campus events</p>

          <form class="space-y-4" onsubmit="event.preventDefault();">
            <div class="form-group">
              <input
                id="name"
                placeholder="Name"
                class="form-input"
                required
              />
            </div>

            <div class="form-group">
              <select id="school" class="form-input" required>
                <option value="">Select your school</option>
                <option value="UNC - Chapel Hill">UNC - Chapel Hill</option>
              </select>
            </div>

            <div class="form-group">
              <select
                id="year"
                onchange="toggleOtherClassInput()"
                class="form-input"
                required
              >
                <option value="">Select your class</option>
                <option value="Freshman">Freshman</option>
                <option value="Sophomore">Sophomore</option>
                <option value="Junior">Junior</option>
                <option value="Senior">Senior</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <div class="form-group hidden" id="other-year-group">
              <input
                id="other-year"
                placeholder="Enter class"
                class="form-input"
              />
            </div>

            <div class="form-group">
              <input
                id="email"
                type="email"
                placeholder="School Email"
                class="form-input"
                required
              />
            </div>

            <div class="form-group">
              <input
                id="password"
                type="password"
                placeholder="Password"
                class="form-input"
                required
              />
            </div>

            <div class="form-group">
              <input
                id="confirm-password"
                type="password"
                placeholder="Verify Password"
                class="form-input"
                required
              />
            </div>

            <button
              id="sign-in-button"
              type="submit"
              class="btn btn-primary btn-full btn-lg"
            >
              Sign Up
            </button>

            <p class="text-center text-sm text-gray-600 mt-4">
              Already have an account?
              <a href="/login" class="text-primary hover:underline font-semibold">Login here</a>
            </p>
          </form>
        </div>
      </div>
    </main>

    <!-- ‚úÖ Footer -->
    <footer class="mt-auto bg-white py-8 text-center border-t border-gray-200">
      <div class="container">
        <p class="text-muted">¬© 2025 TheMove ‚Ä¢ Made with ü©µ at UNC</p>
      </div>
    </footer>

    <!-- ‚úÖ Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
      function showToast(message, type = "info") {
        const toast = document.getElementById("toast");
        toast.className = `toast ${type} show`;
        toast.textContent = message;
        setTimeout(() => {
          toast.classList.remove("show");
        }, 3000);
      }
    </script>

    <!-- ‚úÖ Firebase Logic -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
      import {
        getAuth,
        createUserWithEmailAndPassword,
        setPersistence,
        browserLocalPersistence,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDuHcTFbqy9e0nov4eKHNTp89WVcQOrlTQ",
        authDomain: "themove-c75d3.firebaseapp.com",
        projectId: "themove-c75d3",
        storageBucket: "themove-c75d3.firebasestorage.app",
        messagingSenderId: "445376886249",
        appId: "1:445376886249:web:662ed2bb984ce230a14778",
        measurementId: "G-7E1HKLYXR0",
      };

      (async () => {
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        auth.useDeviceLanguage();
        await setPersistence(auth, browserLocalPersistence);

        async function handleSignUp() {
          const name = document.getElementById("name").value.trim();
          const school = document.getElementById("school").value.trim();
          let year = document.getElementById("year").value.trim();
          const otherYear = document.getElementById("other-year").value.trim();
          const email = document.getElementById("email").value.trim();
          const password = document.getElementById("password").value.trim();
          const confirmPassword = document
            .getElementById("confirm-password")
            .value.trim();

          if (year === "Other" && otherYear) {
            year = otherYear;
          }

          if (
            !name ||
            !school ||
            !year ||
            !email ||
            !password ||
            !confirmPassword
          ) {
            showToast("‚ö†Ô∏è Please fill in all required fields.", "warning");
            return;
          }

          if (!email.toLowerCase().endsWith("@unc.edu")) {
            showToast("‚ùå Email must end with @unc.edu", "error");
            return;
          }

          if (password !== confirmPassword) {
            showToast("‚ùå Passwords do not match.", "error");
            return;
          }

          try {
            const userCred = await createUserWithEmailAndPassword(
              auth,
              email,
              password
            );

            localStorage.setItem(
              "signupData",
              JSON.stringify({ name, school, year })
            );

            const idToken = await userCred.user.getIdToken();
            
            // Create user in backend
            await fetch("https://themove-backend-production.up.railway.app/createUser", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${idToken}`,
              },
              body: JSON.stringify({
                uid: userCred.user.uid,
                name,
                school,
                year,
                emailVerified: false,
              }),
            });

            // Send verification email using new endpoint
            const emailRes = await fetch("https://themove-backend-production.up.railway.app/auth/send-verification-email", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${idToken}`,
              },
            });

            const emailData = await emailRes.json();
            if (emailData.success) {
              showToast(
                "üì® Verification email sent! Please check your inbox and verify your email, then log in to continue.",
                "success"
              );
            } else {
              showToast("Account created, but verification email failed. Please try logging in.", "warning");
            }

            await signOut(auth);
            setTimeout(() => (window.location.href = "/login"), 3000);
          } catch (err) {
            console.error("‚ùå Signup error:", err);
            showToast("Error: " + err.message, "error");
          }
        }

        document
          .getElementById("sign-in-button")
          .addEventListener("click", handleSignUp);
      })();

      window.toggleOtherClassInput = function () {
        const yearSelect = document.getElementById("year");
        const otherYearGroup = document.getElementById("other-year-group");
        const otherYearInput = document.getElementById("other-year");
        if (yearSelect.value === "Other") {
          otherYearGroup.classList.remove("hidden");
          otherYearInput.required = true;
        } else {
          otherYearGroup.classList.add("hidden");
          otherYearInput.required = false;
          otherYearInput.value = "";
        }
      };
    </script>
  </body>
</html>
