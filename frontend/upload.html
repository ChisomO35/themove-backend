<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <title>TheMove - Upload Poster</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/styles.css" />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ["Poppins", "sans-serif"] },
            colors: {
              primary: "#4F46E5",
              accent: "#6366F1",
              background: "#FAFAFA",
              dark: "#1E1B4B",
            },
          },
        },
      };
    </script>
  </head>

  <body class="bg-background text-gray-800 font-sans min-h-screen flex flex-col">
    <!-- ‚úÖ Navbar -->
    <header class="navbar">
      <div class="navbar-container">
        <a href="/" class="navbar-logo">TheMove</a>
        <button class="navbar-mobile-toggle" id="mobileMenuToggle" aria-label="Toggle menu">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
        <nav class="navbar-nav" id="navbarNav">
          <a href="/" class="navbar-link hidden md:inline-block">Home</a>
          <a href="/contact" class="navbar-link hidden md:inline-block">Contact</a>
          <a href="/login" class="btn btn-primary">Logout</a>
        </nav>
      </div>
    </header>
    <script>
      document.getElementById('mobileMenuToggle')?.addEventListener('click', () => {
        document.getElementById('navbarNav')?.classList.toggle('open');
      });
    </script>

    <!-- ‚úÖ Upload Section -->
    <main class="flex-grow flex items-center justify-center py-12 px-4 bg-gradient-to-br from-indigo-50 to-white">
      <div class="container container-sm">
        <div class="card max-w-md mx-auto fade-in">
          <h1 class="heading-2 text-center mb-6">Upload Poster(s) üì§</h1>

        <form id="upload-form" class="flex flex-col gap-5">
          <div>
            <label for="poster" class="block font-medium mb-2 text-gray-700"
              >Poster Images (Select Multiple)</label
            >
            <input
              id="poster"
              name="poster"
              type="file"
              accept="image/*"
              multiple
              required
              class="form-input"
            />
            <p class="text-xs text-gray-500 mt-1">
              You can select multiple images at once
            </p>
          </div>

          <!-- File list display -->
          <div id="file-list" class="hidden">
            <h3 class="text-sm font-semibold mb-2 text-gray-700">Selected Files:</h3>
            <ul id="file-list-items" class="space-y-2 text-sm max-h-40 overflow-y-auto"></ul>
          </div>

          <div class="form-group">
            <label for="school" class="form-label">School</label>
            <select
              id="school"
              name="school"
              required
              class="form-input"
            >
              <option value="UNC-Chapel Hill">UNC-Chapel Hill</option>
            </select>
          </div>

          <button
            type="submit"
            class="btn btn-primary btn-full btn-lg"
            id="submit-btn"
          >
            Upload <span id="file-count">Poster</span>
          </button>
        </form>

        <!-- Upload progress section -->
        <div id="upload-progress" class="hidden mt-6">
          <h3 class="text-sm font-semibold mb-3 text-gray-700">Upload Progress:</h3>
          <div id="progress-list" class="space-y-2 max-h-96 overflow-y-auto"></div>
        </div>

        <!-- ‚úÖ Toast Notification -->
        <div
          id="toast"
          class="hidden mt-5 text-center px-4 py-3 rounded-xl font-medium"
        >          </div>
        </div>
      </div>
    </main>

    <!-- ‚úÖ Footer -->
    <footer class="mt-auto bg-white py-8 text-center border-t border-gray-200">
      <div class="container">
        <div class="mb-4">
          <span class="font-semibold text-primary text-lg">TheMove</span>
          <p class="text-muted mt-2">Your AI Campus Discovery Platform</p>
        </div>
        <div class="flex justify-center gap-6 mb-4">
          <a href="/contact" class="text-gray-600 hover:text-primary transition">Contact</a>
          <a href="/" class="text-gray-600 hover:text-primary transition">Home</a>
        </div>
        <p class="text-muted">¬© 2025 TheMove. Made with ü©µ at UNC.</p>
      </div>
    </footer>

    <!-- ‚úÖ JS Logic -->
    <script>
      const form = document.getElementById("upload-form");
      const toast = document.getElementById("toast");
      const fileInput = document.getElementById("poster");
      const fileList = document.getElementById("file-list");
      const fileListItems = document.getElementById("file-list-items");
      const fileCount = document.getElementById("file-count");
      const submitBtn = document.getElementById("submit-btn");
      const uploadProgress = document.getElementById("upload-progress");
      const progressList = document.getElementById("progress-list");

      // Show selected files
      fileInput.addEventListener("change", (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) {
          fileList.classList.add("hidden");
          fileCount.textContent = "Poster";
          return;
        }

        fileList.classList.remove("hidden");
        fileListItems.innerHTML = "";
        
        files.forEach((file, index) => {
          const li = document.createElement("li");
          li.className = "flex items-center justify-between p-2 bg-gray-50 rounded";
          li.innerHTML = `
            <span class="flex-1 truncate">${file.name}</span>
            <span class="text-xs text-gray-500 ml-2">${(file.size / 1024).toFixed(1)} KB</span>
          `;
          fileListItems.appendChild(li);
        });

        fileCount.textContent = files.length === 1 ? "Poster" : `${files.length} Posters`;
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        
        const files = Array.from(fileInput.files);
        if (files.length === 0) {
          showToast("‚ö†Ô∏è Please select at least one file.", "error");
          return;
        }

        // Disable form during upload
        submitBtn.disabled = true;
        submitBtn.textContent = "Uploading...";
        uploadProgress.classList.remove("hidden");
        progressList.innerHTML = "";

        const results = [];
        let successCount = 0;
        let failCount = 0;

        // Process files sequentially
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const progressItem = createProgressItem(file.name, i);
          progressList.appendChild(progressItem);

          try {
            const formData = new FormData();
            formData.append("poster", file);
            formData.append("school", document.getElementById("school").value);

            updateProgressItem(progressItem, "uploading");

            const response = await fetch("https://themove-backend-production.up.railway.app/extract", {
              method: "POST",
              body: formData,
            });

            if (response.ok) {
              const data = await response.json();
              updateProgressItem(progressItem, "success", data.poster_title || "Uploaded");
              successCount++;
              results.push({ file: file.name, success: true, data });
            } else {
              const errorText = await response.text();
              updateProgressItem(progressItem, "error", errorText || "Upload failed");
              failCount++;
              results.push({ file: file.name, success: false, error: errorText });
            }
          } catch (error) {
            console.error(`Error uploading ${file.name}:`, error);
            updateProgressItem(progressItem, "error", error.message);
            failCount++;
            results.push({ file: file.name, success: false, error: error.message });
          }
        }

        // Re-enable form
        submitBtn.disabled = false;
        submitBtn.textContent = `Upload ${files.length === 1 ? "Poster" : "Posters"}`;

        // Show summary toast
        if (failCount === 0) {
          showToast(`‚úÖ All ${successCount} poster(s) uploaded successfully!`, "success");
          form.reset();
          fileList.classList.add("hidden");
          setTimeout(() => {
            uploadProgress.classList.add("hidden");
          }, 5000);
        } else {
          showToast(
            `‚ö†Ô∏è ${successCount} succeeded, ${failCount} failed. Check details below.`,
            "error"
          );
        }
      });

      function createProgressItem(fileName, index) {
        const div = document.createElement("div");
        div.className = "flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200";
        div.innerHTML = `
          <div class="flex items-center gap-3 flex-1">
            <div class="w-6 h-6 border-2 border-gray-300 border-t-primary rounded-full animate-spin" id="spinner-${index}"></div>
            <div class="flex-1">
              <p class="text-sm font-medium text-gray-800">${fileName}</p>
              <p class="text-xs text-gray-500" id="status-${index}">Uploading...</p>
            </div>
          </div>
          <div id="result-${index}"></div>
        `;
        return div;
      }

      function updateProgressItem(item, status, message = "") {
        const index = item.querySelector('[id^="spinner-"]').id.split("-")[1];
        const spinner = document.getElementById(`spinner-${index}`);
        const statusText = document.getElementById(`status-${index}`);
        const resultDiv = document.getElementById(`result-${index}`);

        spinner.classList.remove("animate-spin", "border-primary", "border-green-500", "border-red-500");
        resultDiv.innerHTML = "";

        if (status === "uploading") {
          spinner.classList.add("animate-spin", "border-primary");
          statusText.textContent = "Uploading...";
        } else if (status === "success") {
          spinner.classList.remove("border-gray-300");
          spinner.classList.add("border-green-500");
          spinner.innerHTML = "‚úì";
          spinner.classList.remove("animate-spin");
          statusText.textContent = message || "Success!";
          statusText.classList.add("text-green-600");
          resultDiv.innerHTML = '<span class="text-green-600 text-sm font-bold">‚úì</span>';
        } else if (status === "error") {
          spinner.classList.remove("border-gray-300");
          spinner.classList.add("border-red-500");
          spinner.innerHTML = "‚úó";
          spinner.classList.remove("animate-spin");
          statusText.textContent = message || "Failed";
          statusText.classList.add("text-red-600");
          resultDiv.innerHTML = '<span class="text-red-600 text-sm font-bold">‚úó</span>';
        }
      }

      function showToast(message, type) {
        toast.textContent = message;
        toast.classList.remove("hidden");
        toast.classList.remove("bg-red-100", "text-red-600", "bg-green-100", "text-green-600");

        if (type === "success") {
          toast.classList.add("bg-green-100", "text-green-600");
        } else {
          toast.classList.add("bg-red-100", "text-red-600");
        }

        setTimeout(() => {
          toast.classList.add("hidden");
        }, 5000);
      }
    </script>
  </body>
</html>
