<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <title>TheMove - Verify Email</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/styles.css" />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ["Poppins", "sans-serif"] },
            colors: {
              primary: "#4F46E5",
              accent: "#6366F1",
              background: "#FAFAFA",
              dark: "#1E1B4B",
            },
          },
        },
      };
    </script>
  </head>

  <body class="bg-background font-sans text-gray-800 flex flex-col min-h-screen">
    <!-- ‚úÖ Navbar -->
    <header class="navbar">
      <div class="navbar-container">
        <a href="/" class="navbar-logo">TheMove</a>
      </div>
    </header>

    <!-- ‚úÖ Main Content -->
    <main class="flex-grow flex items-center justify-center py-12 px-4">
      <div class="container container-sm">
        <div class="card max-w-md mx-auto fade-in">
          <div id="loading-state">
            <h1 class="heading-2 text-center mb-4">Verifying Email...</h1>
            <p class="text-muted text-center">Please wait while we verify your email address.</p>
          </div>

          <div id="success-state" class="hidden">
            <div class="text-center mb-6">
              <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-green-100 mb-4">
                <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
              </div>
              <h1 class="heading-2 mb-2">Email Verified!</h1>
              <p class="text-muted">Your email has been successfully verified.</p>
            </div>
            <a href="/login" class="btn btn-primary btn-full" onclick="localStorage.removeItem('emailVerified')">Continue to Login</a>
          </div>

          <div id="error-state" class="hidden">
            <div class="text-center mb-6">
              <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-100 mb-4">
                <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </div>
              <h1 class="heading-2 mb-2">Verification Failed</h1>
              <p class="text-muted mb-4" id="error-message">The verification link is invalid or has expired.</p>
            </div>
            <a href="/login" class="btn btn-secondary btn-full" onclick="localStorage.removeItem('emailVerified')">Back to Login</a>
          </div>
        </div>
      </div>
    </main>

    <script type="module">
      // FIX #1: Remove token from URL immediately (prevents browser prefetching/reloading same link)
      if (window.location.search.includes("token=")) {
        window.history.replaceState({}, document.title, window.location.pathname);
      }

      // FIX #3: Check if already verified (idempotent client-side check)
      if (localStorage.getItem("emailVerified") === "true") {
        // Already verified - show success immediately
        document.getElementById("loading-state").classList.add("hidden");
        document.getElementById("success-state").classList.remove("hidden");
        // Don't call verifyEmail() again
      } else {
        // Prevent multiple verification calls
        let verificationInProgress = false;
        let verificationCompleted = false;

        // Get token from URL (before we removed it)
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get("token") || new URLSearchParams(window.location.hash.substring(1)).get("token");

      // Verify email and redirect to login
      async function verifyEmail() {
        // Prevent duplicate calls
        if (verificationInProgress || verificationCompleted) {
          console.log("‚ö†Ô∏è [Frontend] Verification already in progress or completed, skipping duplicate call");
          return;
        }
        
        verificationInProgress = true;
        if (!token) {
          // No token - redirect to login with error
          window.location.href = "/login?verified=error&message=" + encodeURIComponent("No verification token provided.");
          return;
        }

        console.log(`üîç [Frontend] Starting email verification for token: ${token.substring(0, 10)}...`);
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
          console.error(`‚è±Ô∏è [Frontend] Verification request timed out`);
          controller.abort();
        }, 15000); // 15 second timeout

        try {
          // No need to encode - base64url tokens are already URL-safe
          const url = `https://themove-backend-production.up.railway.app/auth/verify-email?token=${token}`;
          console.log(`üì§ [Frontend] Sending request to: ${url}`);
          
          const res = await fetch(url, {
            signal: controller.signal,
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            },
            mode: 'cors',
            credentials: 'include'
          });

          clearTimeout(timeoutId);
          console.log(`üì• [Frontend] Response received, status: ${res.status}`);

          if (!res.ok) {
            const errorText = await res.text();
            console.error(`‚ùå [Frontend] HTTP error! status: ${res.status}, body: ${errorText}`);
            // Redirect to login with error
            window.location.href = "/login?verified=error&message=" + encodeURIComponent("Verification failed. Please try again.");
            return;
          }

          const data = await res.json();
          console.log(`‚úÖ [Frontend] Response data:`, data);

          if (data.success) {
            console.log(`‚úÖ [Frontend] Verification successful!`);
            verificationCompleted = true;
            
            // FIX #3: Mark as verified in localStorage (idempotent)
            localStorage.setItem("emailVerified", "true");
            
            // FIX #1: Show success state instead of immediate redirect (prevents browser prefetch)
            document.getElementById("loading-state").classList.add("hidden");
            document.getElementById("success-state").classList.remove("hidden");
          } else {
            console.error(`‚ùå [Frontend] Verification failed:`, data.message);
            verificationCompleted = true;
            
            // FIX #1: Show error state instead of immediate redirect
            document.getElementById("loading-state").classList.add("hidden");
            document.getElementById("error-state").classList.remove("hidden");
            document.getElementById("error-message").textContent = data.message || "Verification failed.";
          }
        } catch (err) {
          clearTimeout(timeoutId);
          console.error("‚ùå [Frontend] Verification error:", err);
          
          let errorMessage = "Verification failed. Please try again.";
          if (err.name === 'AbortError') {
            errorMessage = "Request timed out. Please check your connection and try again.";
          } else if (err.message.includes('Failed to fetch') || err.message.includes('NetworkError')) {
            errorMessage = "Network error. Please check your connection and try again.";
          }
          
          // FIX #1: Show error state instead of immediate redirect
          verificationCompleted = true;
          document.getElementById("loading-state").classList.add("hidden");
          document.getElementById("error-state").classList.remove("hidden");
          document.getElementById("error-message").textContent = errorMessage;
        } finally {
          verificationInProgress = false;
        }
      }

      // Automatically verify (only once)
      if (token) {
        verifyEmail();
      } else {
        // No token - show error state
        document.getElementById("loading-state").classList.add("hidden");
        document.getElementById("error-state").classList.remove("hidden");
        document.getElementById("error-message").textContent = "No verification token provided.";
      }
      }
    </script>
  </body>
</html>

