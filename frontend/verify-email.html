<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- ‚úÖ FIX #2: Prevent browser prefetching -->
    <meta http-equiv="x-dns-prefetch-control" content="off" />
    <meta name="referrer" content="no-referrer" />
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <title>TheMove - Verify Email</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/styles.css" />
  </head>

  <body class="bg-background font-sans text-gray-800 flex flex-col min-h-screen">

    <header class="navbar">
      <div class="navbar-container">
        <a href="/" class="navbar-logo">TheMove</a>
        <button class="navbar-mobile-toggle" id="mobileMenuToggle" aria-label="Toggle menu">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
        <nav class="navbar-nav" id="navbarNav">
          <a href="/" class="navbar-link hidden md:inline-block">Home</a>
          <a href="/contact" class="navbar-link hidden md:inline-block">Contact</a>
          <a href="/login" class="btn btn-secondary">Login</a>
          <a href="/signup" class="btn btn-primary">Join</a>
        </nav>
      </div>
    </header>

    <main class="flex-grow flex items-center justify-center py-12 px-4">
      <div class="container container-sm">
        <div class="card max-w-md mx-auto fade-in">

          <!-- Loading -->
          <div id="loading-state">
            <h1 class="heading-2 text-center mb-4">Verifying Email...</h1>
            <p class="text-muted text-center">Please wait while we verify your email.</p>
          </div>

          <!-- Success -->
          <div id="success-state" class="hidden">
            <div class="text-center mb-6">
              <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-green-100 mb-4">
                <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
              </div>
              <h1 class="heading-2 mb-2">Email Verified!</h1>
              <p class="text-muted">Your email has been successfully verified.</p>
            </div>
            <a href="/login" class="btn btn-primary btn-full">Continue to Login</a>
          </div>

          <!-- Error -->
          <div id="error-state" class="hidden">
            <div class="text-center mb-6">
              <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-100 mb-4">
                <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </div>
              <h1 class="heading-2 mb-2">Verification Failed</h1>
              <p class="text-muted mb-4" id="error-message">The link is invalid or expired.</p>
            </div>
            <a href="/login" class="btn btn-secondary btn-full">Back to Login</a>
          </div>

        </div>
      </div>
    </main>

    <script type="module">
      const loading = document.getElementById("loading-state");
      const success = document.getElementById("success-state");
      const error = document.getElementById("error-state");
      const errorMsg = document.getElementById("error-message");

      const params = new URLSearchParams(window.location.search);
      const token = params.get("token");

      // ‚úÖ FIX: Prevent duplicate verification calls
      // Use localStorage to persist across page reloads/navigation
      const verificationKey = `verification_attempted_${token}`;
      const alreadyAttempted = localStorage.getItem(verificationKey);
      const alreadyCompleted = localStorage.getItem(`verification_completed_${token}`);

      // If already completed, show success immediately
      if (alreadyCompleted === "true") {
        loading.classList.add("hidden");
        success.classList.remove("hidden");
        // Don't run start() again
      } else {
        // Only run if not already attempted
        if (!alreadyAttempted) {
          start();
        } else {
          // Already attempted but not completed - show loading and wait
          console.log("‚è≥ [Frontend] Verification already in progress, waiting...");
        }
      }

      async function start() {
        // ‚úÖ FIX: Mark as attempted immediately to prevent duplicate calls
        localStorage.setItem(verificationKey, "true");

        if (!token) {
          showError("No verification token provided.");
          return;
        }

        try {
          // Verify the email token with cache disabled
          const res = await fetch(
            `https://themove-backend-production.up.railway.app/auth/verify-email?token=${token}`,
            { 
              method: "GET",
              cache: "no-store" // ‚úÖ FIX: Prevent browser caching
            }
          );

          const data = await res.json();

          loading.classList.add("hidden");

          if (data.success === true) {
            // ‚úÖ FIX: Mark as completed to prevent re-verification on page reload
            localStorage.setItem(`verification_completed_${token}`, "true");
            success.classList.remove("hidden");
          } else {
            // If verification failed, check if email might already be verified
            const errorMsg = data.message || "The link is invalid or expired.";
            if (errorMsg.includes("already verified") || errorMsg.includes("try logging in")) {
              // Show success message instead of error
              localStorage.setItem(`verification_completed_${token}`, "true");
              success.classList.remove("hidden");
            } else {
              showError(errorMsg);
            }
          }
        } catch (err) {
          console.error("‚ùå [Frontend] Verification error:", err);
          showError("Network error. Please try again.");
        }
      }

      function showError(msg) {
        loading.classList.add("hidden");
        error.classList.remove("hidden");
        errorMsg.textContent = msg;
      }
    </script>
    <!-- ‚úÖ Footer -->
    <footer class="mt-auto bg-white py-8 text-center border-t border-gray-200">
      <div class="container">
        <div class="mb-4">
          <span class="font-semibold text-primary text-lg">TheMove</span>
          <p class="text-muted mt-2">Your AI Campus Discovery Platform</p>
        </div>
        <div class="flex justify-center gap-6 mb-4">
          <a href="/contact" class="text-gray-600 hover:text-primary transition">Contact</a>
          <a href="/" class="text-gray-600 hover:text-primary transition">Home</a>
        </div>
        <p class="text-muted">¬© 2025 TheMove. Made with ü©µ at UNC.</p>
      </div>
    </footer>
  </body>
</html>
