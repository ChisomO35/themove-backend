<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <title>TheMove - Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/styles.css" />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ["Poppins", "sans-serif"] },
            colors: {
              primary: "#4F46E5",
              accent: "#6366F1",
              background: "#FAFAFA",
              dark: "#1E1B4B",
            },
          },
        },
      };
    </script>
    <style>
      #delete-modal {
        transition: opacity 0.25s ease, transform 0.25s ease;
      }
      #delete-modal.show {
        opacity: 1;
        transform: scale(1);
      }
      #delete-modal.hidden {
        opacity: 0;
        transform: scale(0.98);
      }
    </style>
  </head>

  <body class="bg-background font-sans text-gray-800 flex flex-col min-h-screen">
    <!-- Navbar -->
    <header class="navbar">
      <div class="navbar-container">
        <a href="/" class="navbar-logo">TheMove</a>
        <button class="navbar-mobile-toggle" id="mobileMenuToggle" aria-label="Toggle menu">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
        <nav class="navbar-nav" id="navbarNav">
          <a href="/" class="navbar-link hidden md:inline-block">Home</a>
          <a href="/login" class="btn btn-primary">Logout</a>
        </nav>
      </div>
    </header>
    <script>
      document.getElementById('mobileMenuToggle')?.addEventListener('click', () => {
        document.getElementById('navbarNav')?.classList.toggle('open');
      });
    </script>

    <!-- Main -->
    <main class="flex-grow flex items-center justify-center py-12 px-4">
      <div class="container container-sm">
        <div class="card max-w-md mx-auto fade-in">
          <h1 class="heading-2 text-center mb-2">üë§ Your Profile</h1>
          <p class="text-muted text-center mb-8">View or update your campus info & interests.</p>

          <div class="space-y-6">

          <!-- ‚≠êÔ∏è NEW DAILY DIGEST TOGGLE -->
          <div class="pt-4 border-t border-gray-200">
            <h3 class="text-xl font-semibold text-dark mb-3">üì© Notifications</h3>

            <div class="flex items-center justify-between">
              <label class="font-medium text-gray-800">Receive Daily Digest via SMS</label>
              <input id="digestToggle" type="checkbox" class="w-6 h-6 cursor-pointer" />
            </div>

            <p id="digestDescription" class="mt-3 text-sm text-gray-500 hidden">
              By opting in, you agree to receive 1 SMS per day from TheMove with personalized campus recommendations. Message and data rates may apply. Reply STOP to unsubscribe, HELP for help.
              &nbsp; &nbsp;
              <a href="https://docs.google.com/document/d/1vHUtMH1fnv-YZV8MBMxYnUJtdd0wI5FU4LK9fnEvIv4/edit?usp=sharing" target="_blank" class="text-primary underline hover:text-indigo-700">Privacy Policy
              </a>
              &nbsp;‚Ä¢&nbsp;
              <a href="https://docs.google.com/document/d/1SQU9k9bEPzOAd6fJBm7LIaEE3TiX9CmUsHTMg5EigIE/edit?usp=sharing" target="_blank" class="text-primary underline hover:text-indigo-700">Terms of Service
              </a>
            </p>
          </div>

          <!-- Phone -->
          <div>
            <label class="block font-medium mb-2">Phone Number</label>
            <div class="flex items-center flex-grow border border-gray-300 rounded-xl overflow-hidden focus-within:ring-2 focus-within:ring-primary">
              <span class="px-3 py-2 bg-gray-50 text-gray-700 border-r border-gray-300">+1</span>
              <input
                id="phone"
                placeholder="234 567 8901"
                class="border-0 flex-grow focus:ring-0 outline-none px-4 py-2"
                type="tel"
                maxlength="14"
              />
            </div>
          </div>

          <!-- Dorm -->
          <div>
            <label class="block font-medium mb-2">Dorm / Residence</label>
            <select
              id="dorm"
              class="border border-gray-300 rounded-xl px-4 py-2 w-full focus:ring-2 focus:ring-primary outline-none"
            >
              <option value="">Select your dorm</option>
              <option>Alderman</option><option>Alexander</option><option>Avery</option>
              <option>Carmichael</option><option>Cobb</option><option>Connor</option>
              <option>Craige</option><option>Craige North</option><option>Ehringhaus</option>
              <option>Everett</option><option>Graham</option><option>Grimes</option>
              <option>Hardin</option><option>Hinton James</option><option>Horton</option>
              <option>Joyner</option><option>Kenan</option><option>Koury</option>
              <option>Lewis</option><option>Mangum</option><option>Manly</option>
              <option>McClinton</option><option>McIver</option><option>Morrison</option>
              <option>Old East</option><option>Old West</option><option>Parker</option>
              <option>Ram Village</option><option>Ruffin Jr.</option><option>Spencer</option>
              <option>Stacy</option><option>Taylor</option><option>Teague</option>
              <option>Winston</option><option>Off-Campus</option>
            </select>
          </div>

          <!-- Interests -->
          <div class="mt-10">
            <h3 class="text-xl font-semibold text-dark mb-2">üíú Your Interests</h3>
            <p class="text-gray-500 mb-4">Click to toggle your interests.</p>

            <div class="border-t border-gray-200 pt-4 space-y-8">
              <!-- üé∂ Music -->
              <div>
                <h4 class="font-semibold text-lg mb-2 text-gray-700">üé∂ Music</h4>
                <div class="flex flex-wrap gap-2">
                  <div class="tag">Alternative</div><div class="tag">Hip Hop / Rap</div><div class="tag">R&B</div><div class="tag">Pop</div><div class="tag">Indie</div><div class="tag">EDM / Electronic</div><div class="tag">Cultural</div><div class="tag">Jazz</div><div class="tag">Country</div><div class="tag">Rock</div><div class="tag">Latin</div><div class="tag">Folk</div><div class="tag">Singer/Songwriter</div><div class="tag">Classical</div><div class="tag">Other</div>
                </div>
              </div>

              <!-- üèê Sports -->
              <div>
                <h4 class="font-semibold text-lg mb-2 text-gray-700">üèê Sports & Fitness</h4>
                <div class="flex flex-wrap gap-2">
                  <div class="tag">Basketball</div><div class="tag">Soccer</div><div class="tag">Volleyball</div><div class="tag">Tennis</div><div class="tag">Running</div><div class="tag">Weightlifting</div><div class="tag">Yoga</div><div class="tag">Rugby</div><div class="tag">Swimming</div><div class="tag">Intramurals</div><div class="tag">Fitness & Training</div><div class="tag">Cheer/Dance</div><div class="tag">Other</div>
                </div>
              </div>

              <!-- üé® Arts -->
              <div>
                <h4 class="font-semibold text-lg mb-2 text-gray-700">üé® Arts & Culture</h4>
                <div class="flex flex-wrap gap-2">
                  <div class="tag">Theatre</div><div class="tag">Dance</div><div class="tag">Visual Arts</div><div class="tag">Photography</div><div class="tag">Creative Writing</div><div class="tag">Comedy</div><div class="tag">Film</div><div class="tag">Music Performance</div><div class="tag">Fashion</div><div class="tag">Other</div>
                </div>
              </div>

              <!-- üíº Business -->
              <div>
                <h4 class="font-semibold text-lg mb-2 text-gray-700">üíº Business & Innovation</h4>
                <div class="flex flex-wrap gap-2">
                  <div class="tag">Startups & Entrepreneurship</div><div class="tag">Finance & Investment</div><div class="tag">Marketing & Branding</div><div class="tag">Design</div><div class="tag">Sustainability & Social Impact</div><div class="tag">Media</div><div class="tag">Career Development</div><div class="tag">Nonprofit / NGOs</div><div class="tag">Other</div>
                </div>
              </div>

              <!-- üåø Wellness -->
              <div>
                <h4 class="font-semibold text-lg mb-2 text-gray-700">üåø Wellness & Health</h4>
                <div class="flex flex-wrap gap-2">
                  <div class="tag">Mental Health</div><div class="tag">Fitness & Nutrition</div><div class="tag">Self-Care & Mindfulness</div><div class="tag">Medical / Health Science</div><div class="tag">Other</div>
                </div>
              </div>

              <!-- üíú Charity -->
              <div>
                <h4 class="font-semibold text-lg mb-2 text-gray-700">üíú Charity & Causes</h4>
                <div class="flex flex-wrap gap-2">
                  <div class="tag">Animal Welfare</div><div class="tag">Environment</div><div class="tag">Healthcare</div><div class="tag">Human Rights</div><div class="tag">Poverty & Inequality</div><div class="tag">Education</div><div class="tag">International Aid</div><div class="tag">Disaster Relief</div><div class="tag">Community Service</div><div class="tag">Other</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Save Status Indicator -->
          <div id="save-status" class="pt-4 border-t border-gray-200 hidden">
            <p class="text-sm text-gray-500 text-center">
              <span id="save-status-text">Saving...</span>
            </p>
          </div>

          <!-- Buttons -->
          <div class="space-y-3 pt-8 border-t border-gray-200">
            <button
              onclick="localStorage.clear(); window.location.href='/login';"
              class="bg-gray-100 text-gray-700 w-full py-2.5 rounded-xl font-medium hover:bg-gray-200 transition"
            >
              Logout
            </button>

            <button
              class="bg-red-500 text-white w-full py-2.5 rounded-xl font-medium hover:bg-red-600 transition"
              onclick="deleteAccount()"
            >
              Delete Account
            </button>
          </div>
        </div>
          </div>
        </div>
      </div>
    </main>

    <footer class="mt-auto bg-white py-8 text-center border-t border-gray-200">
      <div class="container">
        <p class="text-muted">¬© 2025 TheMove ‚Ä¢ Made with ü©µ at UNC</p>
      </div>

    <!-- Toast -->
    <div
      id="toast"
      class="fixed top-5 left-1/2 -translate-x-1/2 bg-white shadow-lg rounded-xl px-5 py-3 text-gray-800 font-medium border border-gray-200 opacity-0 pointer-events-none transition-all duration-300 z-50"
    ></div>

    <!-- Delete Modal -->
    <div
      id="delete-modal"
      class="fixed inset-0 flex items-center justify-center bg-black/50 z-50 opacity-0 hidden"
    >
      <div class="bg-white rounded-2xl p-6 w-80 shadow-lg text-center transform transition">
        <h3 class="text-lg font-semibold text-dark mb-2">Delete Account?</h3>
        <p class="text-sm text-gray-600 mb-4">
          ‚ö†Ô∏è Are you sure you want to permanently delete your account? This cannot be undone.
        </p>
        <div class="flex justify-center gap-3">
          <button
            id="cancel-delete"
            class="px-4 py-2 rounded-lg text-gray-700 bg-gray-100 hover:bg-gray-200"
          >
            Cancel
          </button>
          <button
            id="confirm-delete"
            class="px-4 py-2 rounded-lg bg-red-500 text-white hover:bg-red-600"
          >
            Delete
          </button>
        </div>
      </div>
    </div>

    <!-- ‚úÖ Firebase Config (loads from external file, gitignored) -->
    <script src="/firebase-config.js"></script>
    <!-- JS -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
      import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

      // Firebase config loaded from external file (not in git)
      const firebaseConfig = window.__FIREBASE_CONFIG__ || {
        apiKey: "",
        authDomain: "themove-c75d3.firebaseapp.com",
        projectId: "themove-c75d3",
        storageBucket: "themove-c75d3.firebasestorage.app",
        messagingSenderId: "445376886249",
        appId: "1:445376886249:web:662ed2bb984ce230a14778",
        measurementId: "G-7E1HKLYXR0",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);

      function showToast(message, type = "info") {
        const toast = document.getElementById("toast");
        const styles = {
          info: "border-gray-300 bg-white text-gray-800",
          success: "border-green-400 bg-green-50 text-green-700",
          error: "border-red-400 bg-red-50 text-red-700",
          warning: "border-yellow-400 bg-yellow-50 text-yellow-700",
        };
        toast.className = `fixed top-5 left-1/2 -translate-x-1/2 rounded-xl px-5 py-3 font-medium text-center shadow-lg transition-all duration-300 z-50 ${styles[type]}`;
        toast.textContent = message;
        toast.style.opacity = "1";
        toast.style.pointerEvents = "auto";
        setTimeout(() => {
          toast.style.opacity = "0";
          toast.style.pointerEvents = "none";
        }, 3000);
      }

      async function loadProfile() {
        const uid = localStorage.getItem("uid");
        if (!uid) {
          showToast("Please log in first.", "warning");
          window.location.href = "/login";
          return;
        }

        try {
          const res = await fetch(`https://themove-backend-production.up.railway.app/getUser/${uid}`);
          if (!res.ok) return showToast("‚ö†Ô∏è Couldn't load your profile.", "error");

          const user = await res.json();
          document.getElementById("phone").value = user.phone || "";
          document.getElementById("dorm").value = user.dorm || "";

          const saved = new Set(user.interests || []);
          document.querySelectorAll(".tag").forEach((tag) => {
            if (saved.has(tag.textContent)) tag.classList.add("selected");
          });

          // ‚≠êÔ∏è NEW ‚Äî load opt-in state
          document.getElementById("digestToggle").checked = user.dailyDigestOptIn || false;
          document
            .getElementById("digestDescription")
            .classList.toggle("hidden", !user.dailyDigestOptIn);

        } catch {
          showToast("‚ö†Ô∏è Error fetching profile data.", "error");
        }
      }

      // Auto-save functionality with debouncing
      let saveTimeout = null;
      let isSaving = false;

      function showSaveStatus(message, type = "info") {
        const statusEl = document.getElementById("save-status");
        const statusText = document.getElementById("save-status-text");
        statusEl.classList.remove("hidden");
        statusText.textContent = message;
        
        const colors = {
          saving: "text-blue-500",
          success: "text-green-500",
          error: "text-red-500"
        };
        statusText.className = `text-sm ${colors[type] || colors.saving}`;
        
        if (type === "success") {
          setTimeout(() => {
            statusEl.classList.add("hidden");
          }, 2000);
        }
      }

      async function saveProfile() {
        if (isSaving) return; // Prevent concurrent saves
        
        const uid = localStorage.getItem("uid");
        if (!uid) return;

        // Get phone number and add +1 prefix if user only entered 10 digits
        const phoneInput = document.getElementById("phone").value.trim();
        const digits = phoneInput.replace(/\D/g, "");
        const phone = digits.length === 10 ? "+1" + digits : phoneInput.replace(/\D/g, "");
        const dorm = document.getElementById("dorm").value.trim();
        const interests = Array.from(document.querySelectorAll(".tag.selected")).map(
          (t) => t.textContent
        );
        const dailyDigestOptIn = document.getElementById("digestToggle").checked;

        isSaving = true;
        showSaveStatus("Saving...", "saving");

        try {
          const user = auth.currentUser;
          if (!user) {
            showSaveStatus("Session expired. Please log in again.", "error");
            setTimeout(() => (window.location.href = "/login"), 2000);
            return;
          }

          const idToken = await user.getIdToken(true);

          const res = await fetch("https://themove-backend-production.up.railway.app/updateUser", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${idToken}`,
            },
            body: JSON.stringify({ uid, phone, dorm, interests, dailyDigestOptIn }),
          });

          const data = await res.json();
          if (data.success) {
            showSaveStatus("‚úì Saved", "success");
          } else {
            showSaveStatus("Error saving. Please try again.", "error");
          }
        } catch (err) {
          console.error("Error saving profile:", err);
          showSaveStatus("Error saving. Please try again.", "error");
        } finally {
          isSaving = false;
        }
      }

      // Debounced save function
      function debouncedSave() {
        if (saveTimeout) {
          clearTimeout(saveTimeout);
        }
        saveTimeout = setTimeout(() => {
          saveProfile();
        }, 500); // Wait 500ms after user stops making changes
      }

      // Auto-save on dorm change
      document.getElementById("dorm").addEventListener("change", debouncedSave);

      // Auto-save on daily digest toggle
      document.addEventListener("change", (e) => {
        if (e.target.id === "digestToggle") {
          document
            .getElementById("digestDescription")
            .classList.toggle("hidden", !e.target.checked);
          debouncedSave();
        }
      });

      // Auto-save on interest tag click
      document.addEventListener("click", (e) => {
        if (e.target.classList.contains("tag")) {
          e.target.classList.toggle("selected");
          debouncedSave();
        }
      });

      // Auto-save on phone input change (with debounce)
      document.getElementById("phone").addEventListener("input", debouncedSave);

      // Delete Account functionality
      function showDeleteModal() {
        const modal = document.getElementById("delete-modal");
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        setTimeout(() => {
          modal.classList.add("show");
        }, 10);
      }

      function hideDeleteModal() {
        const modal = document.getElementById("delete-modal");
        modal.classList.remove("show");
        setTimeout(() => {
          modal.classList.add("hidden");
          modal.classList.remove("flex");
        }, 250);
      }

      window.deleteAccount = function() {
        showDeleteModal();
      };

      // Cancel delete button
      document.getElementById("cancel-delete").addEventListener("click", () => {
        hideDeleteModal();
      });

      // Confirm delete button
      document.getElementById("confirm-delete").addEventListener("click", async () => {
        const confirmButton = document.getElementById("confirm-delete");
        const originalText = confirmButton.textContent;
        confirmButton.disabled = true;
        confirmButton.textContent = "Deleting...";
        confirmButton.classList.add("opacity-50", "cursor-not-allowed");

        try {
          const user = auth.currentUser;
          if (!user) {
            showToast("Session expired. Please log in again.", "error");
            hideDeleteModal();
            setTimeout(() => (window.location.href = "/login"), 2000);
            return;
          }

          const idToken = await user.getIdToken(true);

          const res = await fetch("https://themove-backend-production.up.railway.app/deleteAccount", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${idToken}`,
            },
          });

          const data = await res.json();
          
          if (data.success) {
            showToast("‚úÖ Account deleted successfully", "success");
            hideDeleteModal();
            
            // Clear local storage and sign out
            localStorage.clear();
            await signOut(auth);
            
            // Redirect to home page
            setTimeout(() => {
              window.location.href = "/";
            }, 1500);
          } else {
            showToast(data.message || "Failed to delete account. Please try again.", "error");
            confirmButton.disabled = false;
            confirmButton.textContent = originalText;
            confirmButton.classList.remove("opacity-50", "cursor-not-allowed");
          }
        } catch (err) {
          console.error("Error deleting account:", err);
          showToast("Error deleting account. Please try again.", "error");
          confirmButton.disabled = false;
          confirmButton.textContent = originalText;
          confirmButton.classList.remove("opacity-50", "cursor-not-allowed");
        }
      });

      // Close modal when clicking outside
      document.getElementById("delete-modal").addEventListener("click", (e) => {
        if (e.target.id === "delete-modal") {
          hideDeleteModal();
        }
      });

      window.onload = loadProfile;
    </script>
  </body> 
</html>
