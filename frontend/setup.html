<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <title>TheMove - Complete Your Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/styles.css" />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ["Poppins", "sans-serif"] },
            colors: {
              primary: "#4F46E5",
              accent: "#6366F1",
              background: "#FAFAFA",
              dark: "#1E1B4B",
            },
          },
        },
      };
    </script>
    <style>
      .category-section {
        @apply border-t border-gray-200 pt-6 mt-6;
      }
    </style>
  </head>

  <body class="bg-background font-sans text-gray-800 flex flex-col min-h-screen">
    <!-- ‚úÖ Navbar -->
    <header class="navbar">
      <div class="navbar-container">
        <a href="/" class="navbar-logo">TheMove</a>
        <button class="navbar-mobile-toggle" id="mobileMenuToggle" aria-label="Toggle menu">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
        <nav class="navbar-nav" id="navbarNav">
          <a href="/login" class="btn btn-secondary">Login</a>
          <a href="/signup" class="btn btn-primary">Join</a>
        </nav>
      </div>
    </header>
    <script>
      document.getElementById('mobileMenuToggle')?.addEventListener('click', () => {
        document.getElementById('navbarNav')?.classList.toggle('open');
      });
    </script>

    <!-- ‚úÖ Main Content -->
    <main class="flex-grow flex items-center justify-center py-12 px-4">
      <div class="container container-sm">
        <div class="card max-w-md mx-auto fade-in">
          <h1 class="heading-2 text-center mb-2">üéØ Complete Your Profile</h1>
          <p class="text-muted text-center mb-8">Customize your campus experience.</p>

        <div class="space-y-8">
          <!-- Phone Section -->
          <div>
            <label class="block font-medium mb-2">Phone Number (for event updates)</label>
            <div class="flex gap-2">
              <div class="flex items-center flex-grow border border-gray-300 rounded-xl overflow-hidden focus-within:ring-2 focus-within:ring-primary">
                <span class="px-3 py-2 bg-gray-50 text-gray-700 border-r border-gray-300">+1</span>
                <input
                  id="phone"
                  placeholder="234 567 8901"
                  class="form-input flex-grow border-0 focus:ring-0"
                  type="tel"
                  maxlength="14"
                />
              </div>
              <button
                id="verify-phone-button"
                onclick="verifyPhoneNumber()"
                class="btn btn-primary"
              >
                Verify
              </button>
            </div>
          </div>

          <!-- Dorm -->
          <div class="form-group">
            <label class="form-label">Dorm / Residence</label>
            <select
              id="dorm"
              class="form-input"
            >
              <option value="">Select your dorm</option>
              <option>Alderman</option><option>Alexander</option><option>Avery</option>
              <option>Carmichael</option><option>Cobb</option><option>Connor</option>
              <option>Craige</option><option>Craige North</option><option>Ehringhaus</option>
              <option>Everett</option><option>Graham</option><option>Grimes</option>
              <option>Hardin</option><option>Hinton James</option><option>Horton</option>
              <option>Joyner</option><option>Kenan</option><option>Koury</option>
              <option>Lewis</option><option>Mangum</option><option>Manly</option>
              <option>McClinton</option><option>McIver</option><option>Morrison</option>
              <option>Old East</option><option>Old West</option><option>Parker</option>
              <option>Ram Village</option><option>Ruffin Jr.</option><option>Spencer</option>
              <option>Stacy</option><option>Taylor</option><option>Teague</option>
              <option>Winston</option><option>Off-Campus</option>
            </select>
          </div>

          <!-- Interests -->
          <div class="mt-8">
            <h3 class="text-xl font-semibold text-dark mb-2 flex items-center gap-1">
              üíú Tell us what you love
            </h3>
            <p class="text-gray-500 mb-6">Select all that match your interests.</p>

            <div class="space-y-8">
              <!-- Each category section with border + spacing -->
              <div class="category-section">
                <h3 class="font-semibold text-lg mb-3">üé∂ Music</h3>
                <div class="flex flex-wrap gap-2">
                  <div class="tag">Alternative</div><div class="tag">Hip Hop / Rap</div><div class="tag">R&B</div>
                  <div class="tag">Pop</div><div class="tag">Indie</div><div class="tag">EDM / Electronic</div>
                  <div class="tag">Cultural</div><div class="tag">Jazz</div><div class="tag">Country</div>
                  <div class="tag">Rock</div><div class="tag">Latin</div><div class="tag">Folk</div>
                  <div class="tag">Singer/Songwriter</div><div class="tag">Classical</div><div class="tag">Other</div>
                </div>
              </div>

              <div class="category-section">
                <h3 class="font-semibold text-lg mb-3">üèê Sports & Fitness</h3>
                <div class="flex flex-wrap gap-2">
                  <div class="tag">Basketball</div><div class="tag">Soccer</div><div class="tag">Volleyball</div>
                  <div class="tag">Tennis</div><div class="tag">Running</div><div class="tag">Weightlifting</div>
                  <div class="tag">Yoga</div><div class="tag">Rugby</div><div class="tag">Swimming</div>
                  <div class="tag">Intramurals</div><div class="tag">Fitness & Training</div><div class="tag">Cheer/Dance</div>
                  <div class="tag">Other</div>
                </div>
              </div>

              <div class="category-section">
                <h3 class="font-semibold text-lg mb-3">üé® Arts & Culture</h3>
                <div class="flex flex-wrap gap-2">
                  <div class="tag">Theatre</div><div class="tag">Dance</div><div class="tag">Visual Arts</div>
                  <div class="tag">Photography</div><div class="tag">Creative Writing</div><div class="tag">Comedy</div>
                  <div class="tag">Film</div><div class="tag">Music Performance</div><div class="tag">Fashion</div>
                  <div class="tag">Other</div>
                </div>
              </div>

              <div class="category-section">
                <h3 class="font-semibold text-lg mb-3">üíº Business & Innovation</h3>
                <div class="flex flex-wrap gap-2">
                  <div class="tag">Startups & Entrepreneurship</div><div class="tag">Finance & Investment</div>
                  <div class="tag">Marketing & Branding</div><div class="tag">Design</div>
                  <div class="tag">Sustainability & Social Impact</div><div class="tag">Media</div>
                  <div class="tag">Career Development</div><div class="tag">Nonprofit / NGOs</div><div class="tag">Other</div>
                </div>
              </div>

              <div class="category-section">
                <h3 class="font-semibold text-lg mb-3">üåø Wellness & Health</h3>
                <div class="flex flex-wrap gap-2">
                  <div class="tag">Mental Health</div><div class="tag">Fitness & Nutrition</div>
                  <div class="tag">Self-Care & Mindfulness</div><div class="tag">Medical / Health Science</div>
                  <div class="tag">Other</div>
                </div>
              </div>

              <div class="category-section">
                <h3 class="font-semibold text-lg mb-3">üíú Charity & Causes</h3>
                <div class="flex flex-wrap gap-2">
                  <div class="tag">Animal Welfare</div><div class="tag">Environment</div><div class="tag">Healthcare</div>
                  <div class="tag">Human Rights</div><div class="tag">Poverty & Inequality</div><div class="tag">Education</div>
                  <div class="tag">International Aid</div><div class="tag">Disaster Relief</div><div class="tag">Community Service</div>
                  <div class="tag">Other</div>
                </div>
              </div>
            </div>
          </div>

          <button
            id="save-profile-button"
            onclick="handleSubmit()"
            class="btn btn-primary btn-full btn-lg mt-8"
          >
            <span id="save-button-text">Save Profile</span>
            <span id="save-button-spinner" class="hidden">
              <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Processing...
            </span>
          </button>
          </div>
        </div>
      </div>
    </main>

    <!-- ‚úÖ Footer -->
    <footer class="mt-auto bg-white py-8 text-center border-t border-gray-200">
      <div class="container">
        <p class="text-muted">¬© 2025 TheMove ‚Ä¢ Made with ü©µ at UNC</p>
      </div>
    </footer>

    <!-- ‚úÖ Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- ‚úÖ Verification Code Modal -->
    <div id="code-modal" class="fixed inset-0 hidden items-center justify-center bg-black/50 z-50 backdrop-blur-sm">
      <div class="card max-w-sm mx-4 text-center">
        <h3 class="heading-3 mb-2">Verify Code</h3>
        <p class="text-muted mb-6">Enter the 6-digit verification code sent to your phone:</p>
        <div class="form-group">
          <input
            id="verification-code"
            maxlength="6"
            placeholder="123456"
            class="form-input text-center"
          />
        </div>
        <div class="flex justify-end gap-3">
          <button id="cancel-code" class="btn btn-ghost">Cancel</button>
          <button id="confirm-code" class="btn btn-primary">Verify</button>
        </div>
      </div>
    </div>

    <script>
      function showToast(message, type = "info") {
        const toast = document.getElementById("toast");
        toast.className = `toast ${type} show`;
        toast.textContent = message;
        setTimeout(() => {
          toast.classList.remove("show");
        }, 3000);
      }
    </script>

    <!-- ‚úÖ Firebase Config (loads from external file, gitignored) -->
    <script src="/firebase-config.js"></script>
    <!-- ‚úÖ Firebase + Logic -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

      // Firebase config loaded from external file (not in git)
      const firebaseConfig = window.__FIREBASE_CONFIG__ || {
        apiKey: "",
        authDomain: "themove-c75d3.firebaseapp.com",
        projectId: "themove-c75d3",
        storageBucket: "themove-c75d3.firebasestorage.app",
        messagingSenderId: "445376886249",
        appId: "1:445376886249:web:662ed2bb984ce230a14778",
        measurementId: "G-7E1HKLYXR0",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);

      let currentUser = null;

      window.addEventListener("DOMContentLoaded", () => {
        onAuthStateChanged(auth, (user) => {
          if (user) {
            currentUser = user;
          } else {
            showToast("Please sign in first.", "warning");
            window.location.href = "/login";
          }
        });
      });

      window.verifyPhoneNumber = async function () {
        const phoneInput = document.getElementById("phone").value.trim();
        if (!phoneInput) {
          showToast("Please enter a valid phone number first.", "warning");
          return;
        }
        
        // Add +1 prefix and strip all non-digit characters before sending to backend
        // User only enters 10 digits, we add the country code
        const digits = phoneInput.replace(/\D/g, "");
        if (digits.length !== 10) {
          showToast("Please enter a valid 10-digit phone number.", "warning");
          return;
        }
        const phone = "+1" + digits;

        try {
          const idToken = await currentUser.getIdToken(true);
          const res = await fetch("https://themove-backend-production.up.railway.app/auth/send-phone-code", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${idToken}`,
            },
            body: JSON.stringify({ phone }),
          });

          const data = await res.json();
          if (data.success) {
            showToast("üì± Verification code sent! Check your phone.", "success");
            document.getElementById("code-modal").classList.remove("hidden");
            document.getElementById("code-modal").classList.add("flex");
            // Store cleaned phone for verification (already stripped of non-digits)
            window.pendingPhone = phone;
          } else {
            showToast(data.message || "Error sending code.", "error");
          }
        } catch (err) {
          console.error(err);
          showToast("Error sending code.", "error");
        }
      };

      document.getElementById("cancel-code").addEventListener("click", () => {
        document.getElementById("code-modal").classList.add("hidden");
      });

      document.getElementById("confirm-code").addEventListener("click", async () => {
        const code = document.getElementById("verification-code").value.trim();
        if (!code) {
          showToast("Enter the verification code.", "warning");
          return;
        }
        try {
          const idToken = await currentUser.getIdToken(true);
          const res = await fetch("https://themove-backend-production.up.railway.app/auth/verify-phone-code", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${idToken}`,
            },
            body: JSON.stringify({ phone: window.pendingPhone, code }),
          });

          const data = await res.json();
          if (data.success) {
            showToast("‚úÖ Phone verified successfully!", "success");
            document.getElementById("code-modal").classList.add("hidden");
            // Update phone input to show it's verified
            document.getElementById("phone").disabled = true;
            document.getElementById("phone").classList.add("bg-green-50");
          } else {
            showToast(data.message || "Invalid code. Try again.", "error");
          }
        } catch (err) {
          console.error(err);
          showToast("Error verifying code.", "error");
        }
      });

      document.addEventListener("click", (e) => {
        if (e.target.classList.contains("tag"))
          e.target.classList.toggle("bg-primary");
      });

      window.handleSubmit = async function () {
        const saveButton = document.getElementById("save-profile-button");
        const buttonText = document.getElementById("save-button-text");
        const buttonSpinner = document.getElementById("save-button-spinner");
        
        // Set loading state
        saveButton.disabled = true;
        buttonText.classList.add("hidden");
        buttonSpinner.classList.remove("hidden");

        try {
          // Get phone number and add +1 prefix if user only entered 10 digits
          const phoneInput = document.getElementById("phone").value.trim();
          const digits = phoneInput.replace(/\D/g, "");
          const phone = digits.length === 10 ? "+1" + digits : phoneInput.replace(/\D/g, "");
          const dorm = document.getElementById("dorm").value.trim();
          const selectedTags = Array.from(document.querySelectorAll(".tag.bg-primary")).map(
            (t) => t.textContent
          );
          const payload = { uid: currentUser.uid, phone, dorm, interests: selectedTags };

          const idToken = await currentUser.getIdToken(true);
          const res = await fetch("https://themove-backend-production.up.railway.app/updateUser", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${idToken}`,
            },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          if (data.success) {
            showToast("‚úÖ Profile saved successfully!", "success");
            // Keep button disabled since we're redirecting
            setTimeout(() => (window.location.href = "/profile"), 2000);
          } else {
            // Reset button state on error
            saveButton.disabled = false;
            buttonText.classList.remove("hidden");
            buttonSpinner.classList.add("hidden");
            showToast(data.message, "warning");
          }
        } catch (err) {
          console.error(err);
          // Reset button state on error
          saveButton.disabled = false;
          buttonText.classList.remove("hidden");
          buttonSpinner.classList.add("hidden");
          showToast("Error updating profile.", "error");
        }
      };
    </script>
  </body>
</html>
